# 01 Aufbau verteilter Systeme
[TOC]

## Einleitung
Ein verteiltes System ist eine Sammlung bestehend aus voneinander unabhängigen Applikationen. Diese werden üblicherweise verteilt über mehrere Rechnerknoten (nodes) hinweg betrieben. Die Applikationen Arbeiten zusammen (Datenaustausch über Schnittstellen / API's), um ein gemeinsames Ziel zu erreichen. ([Umfangreichere Beschreibung](https://www.atlassian.com/de/microservices/microservices-architecture/distributed-architecture))

Aufgrund der Definition ist klar, dass ein verteiltes System aus folgenden Komponenten besteht:
- Voneinander unabhängige Rechner (nodes), wo die einzelnen Softwareteile darauf laufen
- Schnittstellen zwischen den Softwareteilen
- Eine gemeinsame Datenbasis: Diese muss zwischen den unterschiedlichen Teilen synchron gehalten werden. Die Synchronisation der gemeinsamen Datenbasis kann insbesondere beim Ausfall einzelner Komponenten und der anschliessenden Wiederherstellung des Systems eine grosse Herausforderung darstellen (weitere Details siehe [04 Datenhaltung](../04%20Datenhaltung)).

Dadurch, dass die einzelnen Teile unabhängig voneinander sind, ist in der Regel eine Skalierung auch relativ gut umsetzbar (weitere Details siehe [07 Skalierung](../07%20Skalierung)).

Weil bei verteilten Systemen mehrere Rechner miteinander zusammenarbeiten, stellen sich zusätzliche Herausforderungen in Bezug auf Monitoring des Gesamtsystems aber auch bezüglich Testing und Debugging (Details in Kapitel [08 Monitoring und Logging, Testing und Debugging](../08%20Monitoring%20und%20Logging,%20Testing%20und%20Debugging)). Aber auch das Setup von der Entwicklungsumgebung, die auf einem Rechner das gesamte verteilte System simuliert, kann herausfordernd sein. Dank Technologien wie Container oder Infrastructure as Code existieren heute viele Möglichkeiten, wie ein komplettes verteiltes System auf einem Rechner lokal betrieben werden kann (Details lernen Sie im Kapitel [02 Lokale Entwicklungsumgebung](../02%20Lokale%20Entwicklungsumgebung) kennen). Wichtig ist im Zusammenhang mit der sauberen Begriffsdefinition aber darauf zu achten, dass - selbst wenn das verteilte System lokal komplett "simuliert" wird - man bei Entwicklungsumgebungen dann **nicht** mehr von einem verteilten System spricht, weil **nur ein Rechner involviert** ist in den Betrieb des Systems. Ob etwas ein verteiltes System ist oder nicht hängt stark davon ab, wie das System installiert wurde. Die Konzepte die verteilte Systeme nutzen können in lokalen Entwicklungsumgebungen häufig einfacher analysiert und erlernt werden, weshalb die in den Übungsaufgaben zu erstellenden Systeme häufig keine verteilten Systeme sind. Die Grundkonzepte können aber einfach auf die tatsächlich verteilten Systeme angewendet werden.

## Beispiel eines verteilten Systems
Eine Webapplikation mit Frontend, Backend und wenn möglich weiteren Umsystemen ist bereits ein Beispiel für ein verteiltes System (siehe Bild).
![BeispielStrukturVerteilteApplikation.png](BeispielStrukturVerteilteApplikation.png)

Dabei läuft die Logik der Webapplikation auf der Serverseite (Webserver und Datenbank-Server sowie allfällige Webservices) in einem Rechencenter während die Clients (in der Regel die Browser der Webseitenbesucher) auf den Laptops/Mobiles der Webseitenbesucher laufen. Aber nicht nur Webapplikationen gelten als verteiltes System. Auch beispielsweise Dienste wie OneDrive von Microsoft, die es ermöglichen, Dateien zwischen mehreren Endgeräten synchron zu halten, sind verteilte Systeme. Sobald eine Applikation über die Grenzen des eigenen Servers via Netzwerk mit anderen Teilen kommuniziert und so ein Gesamtsystem bildet, wird von verteiltem System gesprochen.

## Ziele von verteilten Systemen
Die folgenden Ziele werden mit einem verteilten System verfolgt:
- **Skalierbarkeit:** Ändert sich das Nutzerverhalten (viel oder wenig User die das System nutzen), dann lässt sich ein verteiltes System einfacher skalieren. Für eine konkrete Aufgabe im System können bei Engpässen einfach neue Knoten dazu gehängt werden (oder wieder entfernt werden, wenn die Leistung nicht mehr benötigt wird).
- **Parallele Verarbeitung:** Dank mehreren Knoten die dieselben Aufgaben erfüllen können, kann eine parallele Verarbeitung stattfinden. Dadurch wird die Latenz (Wartezeit auf die Antwort der Applikation) reduziert.
- **Stabilität / Fehlertoleranz:** Wenn die einzelnen Teile im verteilten System mehrfach (redundant) vorhanden sind, kann die Arbeit beim Ausfall eines Knotens auf die verbleibenden Knoten verteilt werden. Das Gesamtsystem wird dadurch nur etwas langsamer aber fällt nicht komplett aus - ist fehlertolerant.
- **Dezentralisierung und Autonomie:** Dadurch dass die einzelnen Teile unabhängig voneinander betrieben werden können und nicht durch eine zentrale Einheit gesteuert werden müssen, wird die Stabilität und Fehlertoleranz des Gesamtsystems weiter erhöht.
- **Geografische Verteilung:** Dadurch, dass die Knoten unabhängig voneinander betrieben werden können und abhängig von der Anwendung auch nicht übermässig viel Daten austauschen müssen, ist es einfacher möglich die verschiedenen Knoten auch geografisch zu Verteilen. Dadurch wird ein Ausfall des Gesamtsystems verhindert, wenn beispielsweise ein Brand in einem Rechenzentrum dieses (inkl. aller dort gehosteten Knoten) in die Knie geht. Die Knoten an einem anderen Standort können in so einem Fall einfach die Last übernehmen bis ein Ersatz für den ausgefallenen Teil aufgebaut wurde.
- **Kostenreduktion / bessere Ressourcenausnutzung:** Dieses Ziel hängt mit der Skalierbarkeit zusammen. Wird das verteilte System bei unregelmässiger Nutzung herunterskaliert, dann können - insbesondere im Cloud-Umfeld - Rechnerressourcen, die nicht mehr benötigt werden, ausgeschalten werden. Wenn die Nutzung wieder ansteigt, werden die Knoten einfach wieder neu dazu genommen.
- **Flexibilität / Modularität:** Dadurch, dass die einzelnen Teile des Systems unabhängig voneinander Betrieben werden können, kann das Gesamtsystem einfach erweitert oder aktualisiert werden, ohne dieses vom Netz zu nehmen. Beispielsweise für eine Aktualisierung werden Knoten für Knoten vom System getrennt, aktualisiert und anschliessend wieder verbunden, bis das Gesamtsystem aktualisiert wurde. Dadurch werden Ausfallzeiten wegen Wartung vermieden. Erweiterungen des Systems funktionieren ähnlich und ohne dass das System dafür vom Netz genommen werden müsste.

Um diese Ziele zu erreichen, müssen einige zentrale Problemstellungen gelöst werden:
- **Gemeinsame Datenbasis:** In verteilten Systemen gibt es viele Kopien der Daten, damit die einzelnen Teile autonom betrieben werden können. Dies bedeutet aber auch, dass die Daten miteinander synchron gehalten werden müssen. Wenn ein Knoten etwas an den Daten ändert, dann müssen das alle anderen Knoten möglichst zeitnah erfahren, um ihre Berechnungen / Entscheidungen aufgrund der aktuellen Daten zu treffen.
- **Lastenverteilung:** Um die Skalierbarkeit, parallele Verarbeitung und Fehlertoleranz erreichen zu können, müssen die Arbeitslasten sinnvoll verteilt werden können. D. h. es braucht Komponenten, die wissen, welche Knoten (Nodes) wie Stark ausgelastet sind und entsprechend die Aufgaben möglichst fair verteilen. Diese Problemstellung ist nicht ganz so einfach zu lösen. Dies hängt insbesondere damit zusammen, dass auch der Loadbalancer Fehlertolerant / Redundant sein sollte, damit ein Ausfall des Loadbalancers nicht zu einem kompletten Systemausfall führen kann.
- **Bandbreite und Latenz zwischen Systemkomponenten:** gerade wenn das System auch geografisch verteilt werden soll ist es wichtig, dass die einzelnen Teile eine gute und stabile Verbindung zueinander haben. Wenn die Bandbreite aber nur sehr beschränkt zur Verfügung steht, muss geschaut werden, ob bzw. wie der Datenaustausch zwischen den Knoten reduziert werden kann, um Bandbreite zu sparen. Bei Echtzeitanwendungen spielt zusätzlich die Latenz eine Rolle, die - wenn sie zu hoch ist - zu Problemen führen kann.

Weil alle diese Problemstellungen gelöst werden müssen, ist ein verteiltes System ist grundsätzlich komplexer aufgebaut wie ein nicht verteiltes System. Dadurch wird das Debuggen und Überwachen des Gesamtsystems etwas schwieriger. Für alle diese Problemstellungen werden wir in diesem Modul Lösungsansätze, Konzepte und Technologien kennenlernen, mit denen die Probleme angegangen und gelöst werden können.

## Typische Systemkomponenten in einem verteilten System
Als Systemkomponente wird ein konkreter Bestandteil eines verteilten Systems bezeichnet. Das verteilte System baut sich aus verschiedenen Systemkomponenten auf. Die konkreten Systemkomponenten lassen sich nach Aufgabenbereich kategorisieren.

| Kategorie                                  | Beschreibung                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Beispiele                                                                                                                                                                                         |
|--------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Datenkomponenten                           | Datenbanken oder Dateisysteme, die eine persistente Datenspeicherung innerhalb der verteilten Systeme ermöglichen.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Relationale Datenbanken wie MySQL, MS-SQL, PostgreSQL oder auch NoSQL-Datenbanken wie MongoDB<br/>Cluster-Filesysteme wie GlusterFS oder Ceph (https://de.wikipedia.org/wiki/Cluster-Dateisystem) |
| Lastenverteilung und Failover              | Durch die Lastenverteilung werden die zu verarbeitenden Anfragen sinnvoll auf die zur Verfügung stehenden Rechner verteilt. Ein Failover sorgt dafür, dass die Last des ausfallenden Nodes auf die verbleibenden noch aktiven Nodes verteilt wird. So bleibt das Gesamtsystem verfügbar. In der Regel lassen sich Lastverteilung und Failover gut in einem kombinieren.                                                                                                                                                                                                                                                                                                                                  | Eureka Server                                                                                                                                                                                     |
| Management- und Orchestrierungskomponenten | Eng verwandt mit Lastenverteilung und Failover. Es handelt sich um Komponenten, die das Gesamtsystem steuern können. Diese Komponenten können in der Regel auch für Lastenverteilung und Failover eingesetzt werden.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Kubernetes, Docker Swarm, Vagrant, Terraform                                                                                                                                                      |
| Benutzerverwaltung und Berechtigungen      | Zentrale Benutzerverwaltung / Anmeldung / Berechtigung. Die Systemkomponenten die dies tun werden unter dem Kürzel IAM (Identity Access Management) zusammengefasst.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Identity Provider (z. B. Login über Microsoft als identity provider), OAuth - Protokoll für delegierte Zugriffsauthentifizierung (ermöglicht SSO), MFA                                            |
| Service-Management                         | Die zur Verfügung stehenden Services haben in einem dynamischen Umfeld manchmal ändernde Endpunkte. Um die aktuell gülten Endpunkte zu finden (Service discovery) können Service registries eingesetzt werden, die das auffinden der aktuell zur Verfügung stehenden Services erleichtern.                                                                                                                                                                                                                                                                                                                                                                                                               | Eureka Server                                                                                                                                                                                     |
| Proxy-Systeme, Message broker, RPC         | Komponenten, die zwischen den Bestandteilen eines Systems stehen und dazu dienen sollen, die Systeme voneinander unabhängiger zu machen. Kommuniziert ein Service über einen Proxy mit einem anderen Service, dann bemerkt es nicht, wenn der andere Service durch eine neue Version ersetzt wird, weil sich dank dem Proxy der Endpunkt nicht ändert. Wird ein Message broker eingesetzt, dann kann dieser sogar die Daten für den Zielservice zwischenspeichern, bis dieser die Daten benötigt / abholt. Das Ursprungssystem schickt die Daten einfach an den Broker (nach dem Prinzip: fire and forget). Mit RPC (Remote Procedure Call) werden Funktionsaufrufe an entfernte Systeme weitergeleitet. | Apache Kafka, NGINX Reverse Proxy, Thrift (Framework für RPC)                                                                                                                                     |
| Monitoring und Debugging                   | Überwachung der Komponenten im verteilten System. Die Systemkomponenten dieser Kategorie können auch teilweise automatisiert Massnahmen zur Fehlerbehebung einleiten.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | -                                                                                                                                                                                                 |

Die Tabelle nennt nur sehr wenige Beispiellösungen. Es existieren diverse weitere Lösungen, die hier nicht genannt wurden. In der Übungsaufgabe [Recherche Systemkomponenten](./RechercheSystemkomponenten.md) eignen Sie sich vertieftes Wissen über eine / mehrere Kategorien Ihrer Wahl an (inkl. Vergleich der verfügbaren Softwarelösungen und deren Features bzw. Limitierungen).

## Quellen & weiterführende Vertiefung
- https://www.atlassian.com/de/microservices/microservices-architecture/distributed-architecture - Erläuterung zu Microservices
- https://de.wikipedia.org/wiki/Cluster-Dateisystem - Vertiefung in Cluster-Filesysteme
- https://en.wikipedia.org/wiki/Message_broker - Spannend wegen der Liste an möglichen Softwarelösungen für Message broker